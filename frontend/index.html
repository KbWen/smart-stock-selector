<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Stock Selector | AI Edition</title>
    <style>
        :root {
            --bg-color: #0f172a;
            --card-bg: #1e293b;
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --accent: #38bdf8;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --ai-color: #a855f7;
            --border: #334155;
        }

        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            padding: 20px;
        }

        .container {
            max-width: 1100px;
            margin: 0 auto;
        }

        /* Header & Controls */
        header {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border);
            gap: 15px;
        }

        h1 {
            font-size: 2rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--accent) 0%, #818cf8 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin: 0;
            letter-spacing: -1px;
        }

        .controls {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        /* Buttons */
        .btn {
            background-color: var(--card-bg);
            color: var(--text-main);
            padding: 10px 18px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .btn:hover {
            background-color: #273548;
            transform: translateY(-1px);
        }

        .btn-primary {
            background-color: var(--accent);
            color: #0f172a;
            border-color: var(--accent);
        }

        .btn-primary:hover {
            opacity: 0.9;
            background-color: var(--accent);
        }

        .btn-ai {
            background-color: var(--ai-color);
            color: white;
            border-color: var(--ai-color);
        }

        .btn-ai:hover {
            opacity: 0.9;
            background-color: var(--ai-color);
        }

        /* Search */
        .search-box {
            position: relative;
        }

        .search-input {
            background: #1e293b;
            border: 1px solid var(--border);
            padding: 10px 16px;
            border-radius: 8px;
            color: white;
            width: 250px;
            font-size: 0.95rem;
            transition: border-color 0.2s;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .search-results {
            position: absolute;
            top: 110%;
            left: 0;
            width: 100%;
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            max-height: 250px;
            overflow-y: auto;
            z-index: 20;
            display: none;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3);
        }

        .search-item {
            padding: 12px 16px;
            cursor: pointer;
            border-bottom: 1px solid var(--border);
        }

        .search-item:hover {
            background: #273548;
        }

        /* Sync Progress */
        .progress-bar {
            height: 4px;
            background: #334155;
            width: 100%;
            margin-top: 5px;
            border-radius: 2px;
            overflow: hidden;
            display: none;
        }

        .progress-fill {
            height: 100%;
            background: var(--success);
            width: 0%;
            transition: width 0.3s;
        }

        #syncStatus {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-bottom: 20px;
            text-align: right;
            min-height: 1.2em;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .tab-btn {
            background: transparent;
            border: none;
            color: var(--text-muted);
            font-size: 1.1rem;
            font-weight: 600;
            padding: 10px 4px;
            cursor: pointer;
            position: relative;
        }

        .tab-btn.active {
            color: var(--text-main);
        }

        .tab-btn.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: var(--accent);
            border-radius: 2px;
        }

        .tab-btn[data-target="ai"].active::after {
            background: var(--ai-color);
        }

        .tab-btn[data-target="ai"]:hover {
            color: var(--ai-color);
        }

        /* Card & Table */
        .card {
            background-color: var(--card-bg);
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            border: 1px solid var(--border);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead th {
            text-align: left;
            padding: 15px 20px;
            color: var(--text-muted);
            border-bottom: 1px solid var(--border);
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            background: #182234;
        }

        tbody td {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
            vertical-align: middle;
        }

        tbody tr:last-child td {
            border-bottom: none;
        }

        tbody tr:hover {
            background-color: #273548;
            cursor: pointer;
        }

        /* Badges */
        .badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 4px 10px;
            border-radius: 6px;
            font-weight: 700;
            font-size: 0.85rem;
            min-width: 40px;
        }

        .badge-score-high {
            background: rgba(16, 185, 129, 0.15);
            color: var(--success);
        }

        .badge-score-mid {
            background: rgba(245, 158, 11, 0.15);
            color: var(--warning);
        }

        .badge-score-low {
            background: rgba(239, 68, 68, 0.15);
            color: var(--danger);
        }

        .badge-ai {
            background: rgba(168, 85, 247, 0.15);
            color: var(--ai-color);
            border: 1px solid rgba(168, 85, 247, 0.3);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(4px);
            justify-content: center;
            align-items: center;
            z-index: 50;
        }

        .modal.active {
            display: flex;
            animation: fadeIn 0.2s;
        }

        .modal-content {
            background: var(--card-bg);
            padding: 30px;
            border-radius: 16px;
            width: 90%;
            max-width: 650px;
            max-height: 85vh;
            /* NEW: Max height */
            overflow-y: auto;
            /* NEW: Scrollable */
            position: relative;
            border: 1px solid var(--border);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5);
        }

        .close-modal {
            position: absolute;
            top: 20px;
            right: 20px;
            cursor: pointer;
            color: var(--text-muted);
            font-size: 1.5rem;
            transition: color 0.2s;
        }

        .close-modal:hover {
            color: white;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 25px;
        }

        .stat-box {
            background: #273548;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 800;
            margin-bottom: 5px;
        }

        .stat-label {
            color: var(--text-muted);
            font-size: 0.85rem;
        }

        /* AI Box */
        .ai-box {
            background: linear-gradient(135deg, rgba(168, 85, 247, 0.1) 0%, rgba(139, 92, 246, 0.1) 100%);
            border: 1px solid rgba(168, 85, 247, 0.3);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            margin: 20px 0;
        }

        .ai-confidence-high {
            color: var(--success);
        }

        .ai-confidence-med {
            color: var(--warning);
        }

        .ai-confidence-low {
            color: var(--danger);
        }

        .chart-container {
            height: 180px;
            display: flex;
            align-items: flex-end;
            gap: 4px;
            padding-bottom: 5px;
            border-bottom: 1px solid var(--border);
        }

        .chart-bar {
            flex: 1;
            background: #64748b;
            opacity: 0.6;
            border-radius: 2px 2px 0 0;
            position: relative;
        }

        .chart-bar:hover {
            opacity: 1;
            background: var(--accent);
        }

        .chart-bar:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            color: black;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            white-space: nowrap;
            margin-bottom: 5px;
            z-index: 10;
        }

        .loading {
            padding: 50px;
            text-align: center;
            color: var(--text-muted);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: scale(0.95);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <h1>Smart Stock Selector <span
                    style="font-size:0.4em; color:var(--ai-color); vertical-align:super; border:1px solid var(--ai-color); padding:1px 4px; border-radius:4px;">BETA
                    2.0</span></h1>

            <div class="controls">
                <div class="search-box">
                    <input type="text" class="search-input" placeholder="Search Ticker / Name..." id="searchInput">
                    <div class="search-results" id="searchResults"></div>
                </div>
                <button class="btn btn-primary" onclick="triggerSync()">
                    <span>ğŸ”„</span> Sync Data
                </button>
                <button class="btn" onclick="fetchData()">
                    <span>âš¡</span> Refresh
                </button>
            </div>
        </header>

        <div class="progress-bar" id="progressBar">
            <div class="progress-fill" id="progressFill"></div>
        </div>
        <div id="syncStatus"></div>

        <!-- TABS -->
        <div class="tabs">
            <button class="tab-btn active" data-target="technical" onclick="switchTab('technical')">ğŸ”¥ Technical
                Picks</button>
            <button class="tab-btn" data-target="ai" onclick="switchTab('ai')">ğŸ¤– AI Ranking (Top 50)</button>
            <button class="tab-btn" data-target="smart-scan" onclick="switchTab('smart-scan')">ğŸ”” Smart Scans</button>
            <button class="tab-btn" data-target="backtest" onclick="switchTab('backtest')">ğŸ§ª Backtest Lab</button>
        </div>

        <!-- NEW: Definition / Transparency Card -->
        <div id="definition-card"
            style="background: rgba(56, 189, 248, 0.05); border: 1px solid rgba(56, 189, 248, 0.2); border-radius: 12px; padding: 15px; margin-bottom: 20px; font-size: 0.85rem; color: var(--text-muted); line-height: 1.5;">
            <!-- Filled by JS based on Tab -->
        </div>

        <!-- NEW: Sniper Manual (Practical Tips) -->
        <div class="card" style="margin-bottom: 25px; border-left: 4px solid var(--success);">
            <!-- MAIN TABLE -->
            <section class="card">
                <div id="table-container">
                    <div class="loading">Loading...</div>
                </div>
            </section>
        </div>

        <!-- DETAILS MODAL -->
        <div class="modal" id="detailsModal">
            <div class="modal-content">
                <span class="close-modal" onclick="closeModal()">&times;</span>

                <div class="modal-header">
                    <div>
                        <h2 id="modalTicker" style="margin:0">Ticker</h2>
                        <div id="modalPrice" style="font-size:1.5rem; font-weight:bold; margin-top:5px;">$0.00</div>
                    </div>
                    <div class="badge" id="modalScoreBadge" style="font-size:1.5rem; padding:10px 20px;">0</div>
                </div>

                <div class="chart-container" id="modalChart"></div>

                <div class="ai-box">
                    <h4 style="margin:0 0 10px 0; color:var(--ai-color)">ğŸ¯ AI Sniper Prediction (20-Day, 3:1 R/R)</h4>
                    <div id="modalAI" style="font-size:2rem; font-weight:800; margin-bottom:5px;">0%</div>
                    <div id="modalAIConf" style="font-size:0.9rem; margin-bottom:10px;">Waiting...</div>

                    <!-- NEW: AI Consensus Details -->
                    <div id="modal-ai-breakdown"
                        style="display: flex; gap: 8px; justify-content: center; margin: 15px 0; flex-wrap: wrap;">
                    </div>

                    <div id="modalAITargets" style="display:flex; justify-content:center; gap:30px; margin:10px 0">
                        <div><span style="color:var(--success)">ğŸ¯ Target:</span> <span id="modalTarget">$0</span></div>
                        <div><span style="color:var(--danger)">ğŸ›¡ï¸ Stop:</span> <span id="modalStop">$0</span></div>
                    </div>
                    <small style="color:var(--text-muted)">Win = Hit +15% before -5% within 20 days (3:1 R/R)</small>
                </div>

                <div class="stat-box" style="text-align: left; margin-bottom: 20px;">
                    <h4 style="margin:0 0 10px 0; color:white;">ğŸ¤– AI Analyst Report</h4>
                    <div id="modal-analysis" style="font-size: 0.9rem; line-height: 1.6; color: var(--text-muted);">
                        Loading report...
                    </div>
                </div>

                <div class="stats-grid" id="modalStats">
                    <!-- Populated by JS -->
                </div>
            </div>
        </div>

        <script>
            let CURRENT_TAB = 'technical'; // 'technical' or 'ai'
            let abortController = null; // Global controller for cancelling requests

            // Global State for Caching & Persistence
            const APP_STATE = {
                backtest: { status: 'idle', data: null, html: null },
                smartScan: { status: 'idle', data: null },
                ai: { status: 'idle', data: null },
                technical: { status: 'idle', data: null }
            };

            // --- Init ---
            document.addEventListener('DOMContentLoaded', () => {
                updateDefinitionCard();
                renderTabFromState_or_Fetch(); // Use new render logic
                pollSyncStatus();

                // Search Debounce
                let debounceTimer;
                document.getElementById('searchInput').addEventListener('input', (e) => {
                    clearTimeout(debounceTimer);
                    debounceTimer = setTimeout(() => handleSearch(e.target.value), 300);
                });
                // Initial UI Update
                updateDefinitionCard();
            });

            // --- Tabs ---
            function switchTab(tab) {
                if (CURRENT_TAB === tab) return;

                // Cancel any pending request if meaningful
                if (abortController) {
                    // We abort previous requests to "clear the pipe"
                    // But for persisted tabs (backtest), maybe we shouldn't?
                    // For now, let's keep it simple: abort strictly ensures
                    // we don't handle stale responses.
                    console.log("Cancelling previous request due to tab switch");
                    abortController.abort();
                }
                abortController = new AbortController();

                CURRENT_TAB = tab;
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                document.querySelector(`.tab-btn[data-target="${tab}"]`).classList.add('active');
                updateDefinitionCard();

                // Render from State or Fetch
                renderTabFromState_or_Fetch();
            }

            async function renderTabFromState_or_Fetch() {
                const container = document.getElementById('table-container');

                // 1. Handle Backtest specifically (Custom UI)
                if (CURRENT_TAB === 'backtest') {
                    if (APP_STATE.backtest.status === 'done' && APP_STATE.backtest.html) {
                        container.innerHTML = APP_STATE.backtest.html;
                    } else if (APP_STATE.backtest.status === 'loading') {
                        container.innerHTML = `<div class="loading">â³ Traveling back 30 days... (This may take a moment)</div>`;
                    } else {
                        renderDefaultBacktestUI(container);
                    }
                    return;
                }

                // 2. Handle Smart Scan
                if (CURRENT_TAB === 'smart-scan') {
                    if (APP_STATE.smartScan.data) {
                        renderTable(APP_STATE.smartScan.data);
                    } else {
                        fetchSmartScan();
                    }
                    return;
                }

                // 3. Handle Standard Tabs (AI, Technical)
                let stateKey = CURRENT_TAB === 'ai' ? 'ai' : 'technical';

                if (APP_STATE[stateKey].data) {
                    renderTable(APP_STATE[stateKey].data);
                } else {
                    fetchData();
                }
            }

            function renderDefaultBacktestUI(container) {
                container.innerHTML = `
                <div style="text-align:center; padding:40px;">
                    <h3 style="color:var(--text-main)">ğŸ§ª Time Machine Backtest</h3>
                    <p style="color:var(--text-muted)">Verify AI performance by simulating a buy 30 days ago.</p>
                    <button class="btn btn-primary" onclick="runBacktest()" style="padding:15px 30px; font-size:1.2rem; margin-top:20px;">ğŸš€ Start 30-Day Simulation</button>
                </div>
             `;
            }

            function updateDefinitionCard() {
                const card = document.getElementById('definition-card');
                if (CURRENT_TAB === 'technical') {
                    card.style.borderColor = 'rgba(16, 185, 129, 0.2)';
                    card.style.background = 'rgba(16, 185, 129, 0.05)';
                    card.innerHTML = `
                    <div style="display: flex; gap: 20px; align-items: center;">
                        <div style="flex: 1;">
                            <strong style="color: var(--success); display: block; margin-bottom: 5px;">ğŸ”¥ Rise Score (Heuristic Score)</strong>
                            åŸºæ–¼ Trend(40%) + Momentum(30%) + Volatility(30%) æ¬Šé‡è¨ˆç®—çš„æŠ€è¡“é¢ç¸½åˆ†ã€‚
                        </div>
                    </div>
                `;
                } else if (CURRENT_TAB === 'ai' || CURRENT_TAB === 'smart-scan') {
                    const isAI = CURRENT_TAB === 'ai';
                    card.style.borderColor = 'rgba(168, 85, 247, 0.2)';
                    card.style.background = 'rgba(168, 85, 247, 0.05)';

                    let sniperManual = `
                    <div style="width: 100%; margin-top: 15px; display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; padding-top: 15px; border-top: 1px solid rgba(168, 85, 247, 0.1);">
                        <div style="font-size: 0.8rem;">
                            <b style="color: var(--success)">1. AI å…±è­˜ (Consensus)</b>: ä¸‰æ¨¡å‹å‡ > 60% æ™‚è¨Šè™Ÿæœ€å¼·ã€‚
                        </div>
                        <div style="font-size: 0.8rem;">
                            <b style="color: var(--accent)">2. é—œè¯æ€§ (Correlation)</b>: AI é«˜åˆ† + Rise Score é«˜åˆ† = å¼·å‹¢çªç ´ã€‚
                        </div>
                        <div style="font-size: 0.8rem;">
                            <b style="color: var(--error)">3. å¤§ç›¤é¢¨éšª (System Risk)</b>: è‹¥å¤§ç›¤èµ°ç©ºï¼Œæ‰€æœ‰å‹ç‡ä¸‹ä¿® 10-20%ã€‚
                        </div>
                    </div>
                `;

                    card.innerHTML = `
                   <div style="display: flex; flex-direction: column; gap: 10px;">
                        <div style="display: flex; gap: 20px; flex-wrap: wrap; align-items: center;">
                            <div style="flex: 1; min-width: 250px;">
                                <strong style="color: var(--ai-color); display: block; margin-bottom: 5px;">
                                    ${isAI ? 'ğŸ¤– Ensemble AI é æ¸¬é‚è¼¯ (Sniper Strategy)' : 'ğŸ”” Smart Alerts (è¤‡åˆç­–ç•¥)'}
                                </strong>
                                ${isAI ? 'é€éä¸‰å€‹ç•°è³ª ML æ¨¡å‹æŠ•ç¥¨ç”¢ç”Ÿçš„å…±è­˜å‹ç‡é æ¸¬ã€‚' : 'ç¯©é¸ç¬¦åˆç‰¹å®šã€ŒAI + æŠ€è¡“é¢ã€çµ„åˆæ¢ä»¶çš„æ½›åŠ›è‚¡ã€‚'}
                            </div>
                            ${!isAI ? `
                            <div style="flex: 2; display: flex; gap: 15px; flex-wrap: wrap; align-items: center;">
                                <label><input type="checkbox" id="chk-high-ai" checked onchange="fetchSmartScan()"> High AI (>70%)</label>
                                <label><input type="checkbox" id="chk-vol-surge" onchange="fetchSmartScan()"> Volume Surge (>1.5x)</label>
                                <label><input type="checkbox" id="chk-kd-gold" onchange="fetchSmartScan()"> KD Golden Cross</label>
                                <label><input type="checkbox" id="chk-macd-bull" onchange="fetchSmartScan()"> MACD Flip</label>
                            </div>
                            ` : `
                            <div style="flex: 2; display: flex; gap: 15px; font-size: 0.85rem; color: var(--text-muted);">
                                ğŸ·ï¸ Model: <b style="color:var(--ai-color); margin-right: 15px;" id="model-version">Loading...</b>
                                ğŸ•’ Last Sync: <b style="color:var(--text-main)" id="last-sync">--</b>
                            </div>
                            `}
                        </div>
                        ${sniperManual}
                    </div>
                `;
                } else {
                    card.style.borderColor = 'rgba(34, 197, 94, 0.2)';
                    card.style.background = 'rgba(34, 197, 94, 0.05)';
                    card.innerHTML = `
                    <div style="display: flex; gap: 20px; align-items: center;">
                         <strong style="color: var(--success); font-size: 1.1rem;">ğŸ§ª Time Machine Backtest</strong>
                         <div>ä½¿ç”¨éå»çš„æ•¸æ“šä¾†é©—è­‰ AI æ¨¡å‹çš„å¯¦æˆ°è¡¨ç¾ã€‚é€™å¯ä»¥å›ç­”ï¼š"å¦‚æœæˆ‘ 30 å¤©å‰è·Ÿè‘— AI è²·ï¼Œç¾åœ¨è³ºå¤šå°‘ï¼Ÿ"</div>
                         <button class="btn btn-primary" onclick="runBacktest()" style="margin-left: auto;">ğŸš€ Run 30-Day Sim</button>
                    </div>
                 `;
                }
            }

            // --- Fetch Data ---
            async function fetchData() {
                const container = document.getElementById('table-container');
                container.innerHTML = '<div class="loading">Loading...</div>';

                try {
                    let url = '/api/top_picks?sort=score';
                    let stateKey = 'technical';

                    if (CURRENT_TAB === 'ai') {
                        url = '/api/top_picks?sort=ai';
                        stateKey = 'ai';
                    }

                    const res = await fetch(url, { signal: abortController?.signal });

                    if (!res.ok) {
                        const text = await res.text();
                        throw new Error(`Server returned ${res.status}: ${text.substring(0, 100)}...`);
                    }

                    const data = await res.json();

                    // Cache it
                    APP_STATE[stateKey].data = data;
                    APP_STATE[stateKey].status = 'done';

                    // Update Version Info in UI if targeting AI tab
                    if (data.length > 0 && CURRENT_TAB === 'ai') {
                        const first = data[0];
                        const vEl = document.getElementById('model-version');
                        const sEl = document.getElementById('last-sync');
                        if (vEl) vEl.innerText = first.model_version || 'v4.0';
                        if (sEl) {
                            let syncTime = first.last_sync || 'Just now';
                            // Shorten sync time if it's a long timestamp
                            if (syncTime.length > 19) syncTime = syncTime.substring(0, 19);
                            sEl.innerText = syncTime;
                        }
                    }

                    renderTable(data);
                } catch (err) {
                    if (err.name === 'AbortError') return;
                    console.error("Fetch error:", err);
                    container.innerHTML = `<div style="text-align:center; padding:20px; color:var(--error)">Error loading data: ${err.message}</div>`;
                }
            }

            async function fetchSmartScan() {
                const container = document.getElementById('table-container');

                // If we have data and we just switched back, we might want to skip fetch?
                // But this function is also called on checkbox change.
                // Let's just always fetch on interaction, but save to state.

                const criteria = [];
                if (document.getElementById('chk-high-ai')?.checked) criteria.push('high_ai');
                if (document.getElementById('chk-vol-surge')?.checked) criteria.push('vol_surge');
                if (document.getElementById('chk-kd-gold')?.checked) criteria.push('kd_gold');
                if (document.getElementById('chk-macd-bull')?.checked) criteria.push('macd_bull');


                container.innerHTML = '<div class="loading">Scanning Market...</div>';

                try {
                    const res = await fetch('/api/smart_scan', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(criteria),
                        signal: abortController?.signal
                    });
                    const data = await res.json();


                    // Save to State
                    APP_STATE.smartScan.data = data;
                    APP_STATE.smartScan.status = 'done';

                    // Double check if we are still on the smart-scan tab
                    if (CURRENT_TAB === 'smart-scan') {
                        renderTable(data);
                    }
                } catch (err) {
                    if (err.name === 'AbortError') return;
                    container.innerHTML = `<div style="text-align:center; padding:20px; color:var(--error)">Scan Error: ${err.message}</div>`;
                }
            }

            async function runBacktest() {
                const container = document.getElementById('table-container');

                // Set State to Loading
                APP_STATE.backtest.status = 'loading';
                APP_STATE.backtest.html = null;

                container.innerHTML = '<div class="loading">â³ Traveling back 30 days... (This may take a moment)</div>';

                try {
                    // We do NOT use abortController here if we want it to persist? 
                    // Actually, if we use the global abortController, switching tabs cancels it.
                    // To keep it running, we should use a separate controller or none.
                    // Let's use none for backtest to allow background processing.
                    const res = await fetch('/api/backtest?days=30');
                    const data = await res.json();

                    // Render Backtest Result
                    if (data.error || data.detail) {
                        const errorMsg = data.error || data.detail;
                        const errorHtml = `<div style="text-align:center; padding:20px; color:var(--error)">Backtest Error: ${errorMsg}</div>`;
                        container.innerHTML = errorHtml;
                        APP_STATE.backtest.status = 'error';
                        return;
                    }

                    const summary = data.summary;
                    const picks = data.top_picks || data.top_10_picks; // Backward compatibility

                    let html = `
                    <div style="padding:20px; animation: fadeIn 0.5s;">
                        <h2 style="text-align:center; color:var(--text-main); margin-bottom:5px;">ğŸ§ª Simulation Result</h2>
                        <p style="text-align:center; color:var(--text-muted); margin-bottom:10px;">Entry Date: ${data.simulated_date} (30 Days Ago)</p>
                        
                        <div style="text-align:center; margin-bottom:20px;">
                            <span class="badge" style="background:rgba(255,255,255,0.05); color:var(--text-muted); font-size:0.8rem; padding:5px 12px;">
                                ğŸ“Š Candidate Pool: ${data.candidate_pool_size || 'N/A'} stocks scanned
                                <span style="margin:0 10px;">|</span>
                                ğŸ¯ AI Range: ${(data.ai_prob_min || 0).toFixed(0)}% - ${(data.ai_prob_max || 0).toFixed(0)}%
                            </span>
                        </div>

                        <div style="display:grid; grid-template-columns: repeat(3, 1fr); gap:15px; margin-bottom:25px;">
                            <div class="stat-box" style="text-align:center; border: 1px solid ${summary.avg_return > 0 ? 'var(--success)' : 'var(--error)'}">
                                <div style="color:var(--text-muted)">Avg Return (30d)</div>
                                <div style="font-size:1.8rem; font-weight:bold; color: ${summary.avg_return > 0 ? 'var(--success)' : 'var(--error)'}">
                                    ${(summary.avg_return * 100).toFixed(1)}%
                                </div>
                            </div>
                            <div class="stat-box" style="text-align:center;">
                                <div style="color:var(--text-muted)">Win Rate</div>
                                <div style="font-size:1.8rem; font-weight:bold; color:var(--accent)">
                                    ${(summary.win_rate * 100).toFixed(0)}%
                                </div>
                            </div>
                             <div class="stat-box" style="text-align:center;">
                                <div style="color:var(--text-muted)">Best Pick</div>
                                <div style="font-size:1.2rem; font-weight:bold; color:var(--text-main)">
                                    ${summary.best_stock}
                                </div>
                                <div style="color:${summary.best_return > 0 ? 'var(--success)' : 'var(--error)'}">
                                    ${(summary.best_return * 100).toFixed(1)}%
                                </div>
                            </div>
                            
                            <!-- Strategy Recommendation Card -->
                            <div class="stat-box" style="grid-column: span 3; background: rgba(var(--accent-rgb), 0.1); border: 1px dashed var(--accent); padding:15px; text-align:left;">
                                <div style="font-weight:bold; margin-bottom:8px; display:flex; align-items:center;">
                                    <span style="font-size:1.4rem; margin-right:10px;">ğŸ›¡ï¸</span> ç­–ç•¥å»ºè­°ï¼šé›†ä¸­æ”»ç•¥ (Concentrated Strategy)
                                </div>
                                <div style="font-size:0.85rem; color:var(--text-muted); line-height:1.5;">
                                    <b>åŸ·è¡Œæ¢ä»¶ï¼š</b>æƒæå€™é¸æ±  500 æª” â†’ æ’é™¤ä½åƒ¹è‚¡ (<$15) â†’ é–å®š AI æ©Ÿç‡ > 40% â†’ æŒ‘é¸æœ€å¼· 10 åã€‚<br>
                                    <b>å¯¦æˆ°æŒ‡å—ï¼š</b>å›æ¸¬é¡¯ç¤ºç•¶å‰æ¨¡å‹åœ¨ã€Œåˆ†æ•£æŠ•è³‡å‰10åã€æ™‚å…·å‚™æ¥µé«˜éŸŒæ€§ã€‚å»ºè­°ç­‰æ¬Šé‡åˆ†é…è³‡é‡‘æ–¼å‰ 10 æª”ï¼ŒæŒæœ‰æœŸé–“ç´„ 20-30 å¤©ï¼Œå¯æ•æ‰å¤§è´å®¶åŒæ™‚è¦é¿å–®ä¸€æ¨™çš„å›æª”é¢¨éšªã€‚
                                </div>
                            </div>
                        </div>
                        
                        <h3 style="margin-bottom:15px;">ğŸ“œ Top 10 High Confidence Picks</h3>
                        <div class="table-wrapper">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Ticker</th>
                                        <th>Entry Price</th>
                                        <th>Current Price</th>
                                        <th>AI Prob (Then)</th>
                                        <th style="text-align:right">Return</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;

                    // Add rows
                    picks.forEach(p => {
                        const retColor = p.actual_return > 0 ? 'var(--success)' : 'var(--error)';
                        const prob = (p.ai_prob_at_entry * 100).toFixed(0);

                        // Confidence Coloring
                        let probStyle = 'background:rgba(255,255,255,0.05); color:var(--accent)';
                        if (prob >= 60) {
                            probStyle = 'background:rgba(46, 204, 113, 0.2); color:var(--success)';
                        } else if (prob >= 40) {
                            probStyle = 'background:rgba(241, 196, 15, 0.2); color:#f1c40f';
                        }

                        html += `
                        <tr style="border-bottom: 1px solid rgba(255,255,255,0.05);">
                            <td>
                                <span style="font-weight:bold; color:var(--text-main)">${p.ticker}</span> 
                                ${p.name && p.name !== p.ticker ? `<span style="color:var(--text-muted); font-size:0.9em">${p.name}</span>` : ''}
                            </td>
                            <td>$${p.entry_price.toFixed(1)}</td>
                            <td>$${p.current_price.toFixed(1)}</td>
                            <td><span class="badge" style="${probStyle}; min-width:40px;">${prob}%</span></td>
                            <td style="text-align:right; color:${retColor}; font-weight:bold;">
                                ${(p.actual_return * 100).toFixed(1)}%
                            </td>
                        </tr>
                    `;
                    });

                    html += `</tbody></table></div></div>
                    <div style="text-align:center; margin-top:30px;">
                        <button class="btn" onclick="APP_STATE.backtest.status='idle'; renderDefaultBacktestUI(document.getElementById('table-container'))">ğŸ”„ Run Another Simulation</button>
                    </div>
                `;

                    // Save Result to State
                    APP_STATE.backtest.status = 'done';
                    APP_STATE.backtest.html = html;

                    // Only render if we are still on the backtest tab
                    if (CURRENT_TAB === 'backtest') {
                        container.innerHTML = html;
                    }

                } catch (err) {
                    // If we didn't use abortController, this is a real network error
                    if (CURRENT_TAB === 'backtest') {
                        container.innerHTML = `<div style="text-align:center; padding:20px; color:var(--error)">Backtest Error: ${err.message}</div>`;
                    }
                    APP_STATE.backtest.status = 'error';
                }
            }

            function renderTable(data) {
                const container = document.getElementById('table-container');
                if (data.length === 0) {
                    container.innerHTML = '<div class="loading">No stocks found. Try syncing data first.</div>';
                    return;
                }

                // Headers
                let headers = `
                <th>Ticker</th>
                <th>Name</th>
                <th>Price</th>
                <th>Change</th>
            `;
                if (CURRENT_TAB === 'ai') {
                    headers += `
                    <th><i class="fas fa-bullseye"></i> Target</th>
                    <th><i class="fas fa-hand-paper"></i> Stop</th>
                    <th><i class="fas fa-ruler-combined"></i> Rise Score</th>
                    <th><i class="fas fa-signal"></i> Signal</th>
                    <th><i class="fas fa-brain"></i> AI Prob</th>
                `;
                } else {
                    headers += `<th>Trend</th><th>Momentum</th><th style="text-align:right">Rise Score</th>`;
                }

                let rows = data.map(item => {
                    const score = item.score;
                    const ai = item.ai_probability || 0;

                    // Color logic
                    let scoreClass = 'badge-score-low';
                    if (score.total_score >= 80) scoreClass = 'badge-score-high';
                    else if (score.total_score >= 60) scoreClass = 'badge-score-mid';

                    const changeColor = score.change_percent >= 0 ? 'var(--success)' : 'var(--danger)';
                    const changeSign = score.change_percent >= 0 ? '+' : '';

                    let extraCols = '';
                    if (CURRENT_TAB === 'technical') {
                        extraCols = `
                        <td>${score.trend_score.toFixed(0)}</td>
                        <td>${score.momentum_score.toFixed(0)}</td>
                        <td style="text-align:right"><span class="badge ${scoreClass}">${score.total_score.toFixed(0)}</span></td>
                    `;
                    } else {
                        let aiClass = 'var(--text-muted)';
                        if (ai > 0.3) aiClass = 'var(--success)';
                        else if (ai > 0.15) aiClass = 'var(--warning)';

                        const pct = (ai * 100).toFixed(1) + '%';
                        const targetP = item.ai_target_price || (score.last_price * 1.15).toFixed(2);
                        const stopP = item.ai_stop_price || (score.last_price * 0.95).toFixed(2);
                        // Rise Score Logic (Color scaling)
                        const riseScore = score.total_score || 0;
                        let riseColor = 'var(--text-muted)';
                        if (riseScore >= 80) riseColor = 'var(--success)';
                        else if (riseScore >= 60) riseColor = 'var(--warning)';

                        extraCols = `
                        <td style="color:var(--success)">$${parseFloat(targetP).toFixed(1)}</td>
                        <td style="color:var(--danger)">$${parseFloat(stopP).toFixed(1)}</td>
                        <td style="color:${riseColor}; font-weight:bold;">${riseScore}</td>
                        <td style="color:${aiClass}">${ai > 0.3 ? 'ğŸ”¥ High' : (ai > 0.15 ? 'âš¡ Med' : 'ğŸ’¤ Low')}</td>
                        <td style="text-align:right"><span class="badge badge-ai">${pct}</span></td>
                    `;
                    }

                    return `
                    <tr onclick="openDetail('${item.ticker}')">
                        <td style="font-weight:bold; color:var(--accent)">${item.ticker}</td>
                        <td style="color:white">${item.name}</td>
                        <td>${score.last_price.toFixed(2)}</td>
                        <td style="color:${changeColor}">${changeSign}${score.change_percent.toFixed(2)}%</td>
                        ${extraCols}
                    </tr>
                `;
                }).join('');

                container.innerHTML = `
                <table>
                    <thead><tr>${headers}</tr></thead>
                    <tbody>${rows}</tbody>
                </table>
            `;
            }

            // --- Modal ---
            async function openDetail(ticker) {
                const modal = document.getElementById('detailsModal');
                document.getElementById('searchResults').style.display = 'none';
                document.getElementById('searchInput').value = '';

                modal.classList.add('active');

                // Set Loading
                document.getElementById('modalTicker').innerText = ticker;
                document.getElementById('modalPrice').innerText = 'Loading...';
                document.getElementById('modalAI').innerText = '...';
                document.getElementById('modalChart').innerHTML = '';
                document.getElementById('modalStats').innerHTML = '';
                document.getElementById('modal-analysis').innerText = 'Generating report...';
                document.getElementById('modal-ai-breakdown').innerHTML = '';

                try {
                    const res = await fetch(`/api/stock/${ticker}`);
                    const data = await res.json();

                    const score = data.score;
                    const ai = data.ai_probability || 0;
                    const analysis = score.analysis || { trend: 'N/A', momentum: 'N/A', setup: 'N/A' };

                    // Header
                    document.getElementById('modalTicker').innerText = `${data.ticker} ${score.name || ''}`; // Name might be missing in detail API
                    document.getElementById('modalPrice').innerText = `$${score.last_price.toFixed(2)}`;
                    document.getElementById('modalScoreBadge').innerText = score.total_score.toFixed(0);

                    // Color Badge
                    const b = document.getElementById('modalScoreBadge');
                    b.className = 'badge';
                    if (score.total_score >= 80) b.classList.add('badge-score-high');
                    else if (score.total_score >= 60) b.classList.add('badge-score-mid');
                    else b.classList.add('badge-score-low');

                    // AI
                    const aiEl = document.getElementById('modalAI');
                    const aiConf = document.getElementById('modalAIConf');
                    aiEl.innerText = (ai * 100).toFixed(1) + '%';

                    // Target / Stop prices
                    const targetP = data.ai_target_price || (score.last_price * 1.15);
                    const stopP = data.ai_stop_price || (score.last_price * 0.95);
                    document.getElementById('modalTarget').innerText = `$${parseFloat(targetP).toFixed(1)}`;
                    document.getElementById('modalStop').innerText = `$${parseFloat(stopP).toFixed(1)}`;

                    if (ai >= 0.3) {
                        aiEl.style.color = 'var(--success)';
                        aiConf.innerText = "ğŸ”¥ Strong Signal - Sniper Setup!";
                        aiConf.className = 'ai-confidence-high';
                    } else if (ai >= 0.15) {
                        aiEl.style.color = 'var(--warning)';
                        aiConf.innerText = "âš¡ Medium Signal";
                        aiConf.className = 'ai-confidence-med';
                    } else {
                        aiEl.style.color = 'var(--text-muted)';
                        aiConf.innerText = "ğŸ’¤ Weak Signal";
                        aiConf.className = 'ai-confidence-low';
                    }

                    // AI Breakdown (NEW)
                    const breakdownContainer = document.getElementById('modal-ai-breakdown');
                    breakdownContainer.innerHTML = '';
                    const details = data.score.ai_details || {};

                    if (Object.keys(details).length > 0) {
                        const weightInfo = document.createElement('div');
                        weightInfo.style.fontSize = '0.7rem';
                        weightInfo.style.color = 'var(--text-muted)';
                        weightInfo.style.marginBottom = '5px';
                        weightInfo.innerHTML = 'âš–ï¸ Voting Consensus (Equal Weight 1/3 each)';
                        breakdownContainer.appendChild(weightInfo);

                        const itemsContainer = document.createElement('div');
                        itemsContainer.style.display = 'flex';
                        itemsContainer.style.gap = '10px';
                        itemsContainer.style.justifyContent = 'center';
                        itemsContainer.style.width = '100%';

                        for (const [model, prob] of Object.entries(details)) {
                            if (model === 'legacy') continue;
                            const p = (prob * 100).toFixed(0);
                            const barColor = prob > 0.6 ? 'var(--success)' : (prob > 0.5 ? 'var(--accent)' : 'var(--text-muted)');

                            const item = document.createElement('div');
                            item.style.padding = '4px 10px';
                            item.style.background = 'rgba(255,255,255,0.05)';
                            item.style.borderRadius = '6px';
                            item.style.border = '1px solid var(--border)';
                            item.style.textAlign = 'center';
                            item.style.minWidth = '70px';
                            item.innerHTML = `
                            <div style="font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase;">${model}</div>
                            <div style="font-size: 1rem; font-weight: bold; color: ${barColor};">${p}%</div>
                        `;
                            itemsContainer.appendChild(item);
                        }
                        breakdownContainer.appendChild(itemsContainer);
                    }

                    // AI Analyst Report (Consolidated)
                    document.getElementById('modal-analysis').innerHTML = `
                    <p style="margin:5px 0"><strong style="color:var(--accent)">Trend:</strong> ${analysis.trend}</p>
                    <p style="margin:5px 0"><strong style="color:var(--accent)">Momentum:</strong> ${analysis.momentum}</p>
                    <p style="margin:5px 0"><strong style="color:var(--accent)">Setup:</strong> ${analysis.setup}</p>
                `;

                    // Stats Grid
                    document.getElementById('modalStats').innerHTML = `
                    <div class="stat-box" title="Based on Price vs SMA 20/60 (Max: 40)">
                        <div class="stat-value">${score.trend_score.toFixed(0)}<span style="font-size:0.7rem; color:var(--text-muted)">/40</span></div>
                        <div class="stat-label">Trend Score</div>
                    </div>
                    <div class="stat-box" title="Based on RSI Wilder & KD Golden Cross (Max: 30)">
                        <div class="stat-value">${score.momentum_score.toFixed(0)}<span style="font-size:0.7rem; color:var(--text-muted)">/30</span></div>
                        <div class="stat-label">Momentum</div>
                    </div>
                    <div class="stat-box" title="Based on BB Squeeze & Volume Breakthrough (Max: 30)">
                        <div class="stat-value">${score.volatility_score.toFixed(0)}<span style="font-size:0.7rem; color:var(--text-muted)">/30</span></div>
                        <div class="stat-label">Volatility</div>
                    </div>
                `;

                    // Chart
                    const history = data.history;
                    if (history && history.length > 0) {
                        const prices = history.map(h => h.close);
                        const minP = Math.min(...prices);
                        const maxP = Math.max(...prices);
                        const range = maxP - minP || 1;

                        const bars = history.map(h => {
                            const hPct = ((h.close - minP) / range) * 80 + 10;
                            return `<div class="chart-bar" style="height:${hPct}%" data-tooltip="${h.date}: ${h.close}"></div>`;
                        }).join('');
                        document.getElementById('modalChart').innerHTML = bars;
                    }

                } catch (e) {
                    console.error(e);
                }
            }

            function closeModal() {
                document.getElementById('detailsModal').classList.remove('active');
            }

            // --- Search ---
            async function handleSearch(q) {
                if (q.length < 2) {
                    document.getElementById('searchResults').style.display = 'none';
                    return;
                }
                const res = await fetch(`/api/stocks?q=${q}`);
                const data = await res.json();
                const div = document.getElementById('searchResults');

                if (data.length) {
                    div.innerHTML = data.map(s =>
                        `<div class="search-item" onclick="openDetail('${s.code}')">
                        <span style="color:var(--accent); font-weight:bold">${s.code}</span> 
                        <span style="color:white">${s.name}</span>
                    </div>`
                    ).join('');
                    div.style.display = 'block';
                } else {
                    div.innerHTML = '<div class="search-item">No results</div>';
                    div.style.display = 'block';
                }
            }

            // --- Sync ---
            async function triggerSync() {
                if (!confirm("Start background sync (~10 mins)?")) return;
                await fetch('/api/sync', { method: 'POST' });
                pollSyncStatus();
            }

            async function pollSyncStatus() {
                const bar = document.getElementById('progressBar');
                const fill = document.getElementById('progressFill');
                const txt = document.getElementById('syncStatus');
                const syncBarParent = document.getElementById('progressBar'); // The parent container for the progress bar
                const syncBar = document.getElementById('progressFill'); // The actual fill element
                const syncLabel = document.getElementById('syncStatus'); // The text label

                const timer = setInterval(async () => {
                    const res = await fetch('/api/sync/status');
                    const data = await res.json(); // Renamed 's' to 'data' for consistency with the provided snippet

                    if (data.is_syncing) {
                        syncBarParent.style.display = 'block';
                        const percent = (data.current / data.total) * 100;
                        syncBar.style.width = percent + '%';
                        let statusText = `Syncing... ${data.current} / ${data.total}`;
                        if (data.current_ticker) {
                            statusText += ` <span style="color:var(--primary); font-size:0.8rem; margin-left:10px;">[ ${data.current_ticker} ]</span>`;
                        }
                        syncLabel.innerHTML = statusText;
                    } else {
                        syncLabel.innerText = "";
                    }

                    if (!data.is_syncing && data.current > 0 && data.current >= data.total) { // Simple done check
                        clearInterval(timer);
                        txt.innerText = "Sync Done!";
                        setTimeout(() => { bar.style.display = 'none'; txt.innerText = ''; fetchData(); }, 2000);
                    }
                }, 2000);
            }
        </script>
</body>

</html>